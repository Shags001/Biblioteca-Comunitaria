{% extends 'layouts/base.html' %}

{% block title %}Gestión de Libros{% endblock %}

{% block content %}
<main class="container mt-4 rol-container" data-user-role="{{ user_role or '' }}" data-auth="{{ 'true' if is_authenticated else 'false' }}">
    <div class="main-content">
        <div class="content-header">
            <h1 class="page-title">Gestión de Libros</h1>
            {% if is_authenticated and user_role == 'Administrador' %}
            <button class="btn-primary-custom d-flex align-items-center" id="btnAgregarLibro">
                <i data-lucide="plus" class="me-2"></i><span class="btn-label">Agregar Libro</span>
            </button>
            {% endif %}
        </div>
        <div class="search-bar mb-3 d-flex align-items-center">
            <span class="input-group-text"><i data-lucide="search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Buscar por título, autor, género, editorial...">
        </div>
        <div class="table-container">
            <div class="table-responsive-custom">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th><i data-lucide="hash" class="me-1"></i>ID</th>
                            <th><i data-lucide="book-open" class="me-1"></i>Título</th>
                            <th><i data-lucide="user" class="me-1"></i>Autor</th>
                            <th><i data-lucide="barcode" class="me-1"></i>ISBN</th>
                            <th><i data-lucide="tag" class="me-1"></i>Género</th>
                            <th><i data-lucide="factory" class="me-1"></i>Editorial</th>
                            <th><i data-lucide="calendar" class="me-1"></i>Año</th>
                            <th><i data-lucide="layers" class="me-1"></i>Libros</th>
                            <th><i data-lucide="layers" class="me-1"></i>Disponibles</th>
                            <th><i data-lucide="archive" class="me-1"></i>Prestados</th>
                            <th><i data-lucide="align-left" class="me-1"></i>Descripción</th>
                            <th><i data-lucide="edit-3" class="me-1"></i>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="booksTableBody">
                        <!-- Los libros se cargarán dinámicamente aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar/Editar Libro -->
    <div class="modal-overlay d-none" id="bookModal">
        <div class="modal-custom">
            <div class="modal-header-custom d-flex flex-row justify-content-between align-items-center">
                <h2 class="modal-title" id="modalTitle">Agregar Libro</h2>
                <button class="btn-close-modal" id="btnCerrarModal">✕</button>
            </div>
            <div class="modal-body-custom">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="bookTitle" class="form-label"><i data-lucide="book-open" class="me-2"></i>Título</label>
                            <input type="text" class="form-control" id="bookTitle" placeholder="Título del libro" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="bookAuthor" class="form-label"><i data-lucide="user" class="me-2"></i>Autor</label>
                            <input type="text" class="form-control" id="bookAuthor" placeholder="Autor" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="bookISBN" class="form-label"><i data-lucide="barcode" class="me-2"></i>ISBN</label>
                            <input type="text" class="form-control" id="bookISBN" placeholder="Código ISBN">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="bookGenreInput" class="form-label"><i data-lucide="tag" class="me-2"></i>Género</label>
                            <!-- Custom responsive genre picker: controlled by JS -->
                            <div class="custom-select-container">
                                <div class="custom-select-input form-control" id="bookGenreInput" tabindex="0" role="combobox" aria-expanded="false">Selecciona un género</div>
                                <div class="custom-select-options d-none" id="bookGenreOptions" role="listbox"></div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="bookPublisher" class="form-label"><i data-lucide="factory" class="me-2"></i>Editorial</label>
                            <input type="text" class="form-control" id="bookPublisher" placeholder="Editorial">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="bookYear" class="form-label"><i data-lucide="calendar" class="me-2"></i>Año</label>
                            <input type="number" class="form-control" id="bookYear" placeholder="Año" min="1800" max="2025">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="bookCopies" class="form-label"><i data-lucide="layers" class="me-2"></i>Ejemplares</label>
                            <input type="number" class="form-control" id="bookCopies" placeholder="Cantidad" min="1" required>
                        </div>
                        <div class="col-12">
                            <label for="bookDescription" class="form-label"><i data-lucide="align-left" class="me-2"></i>Descripción</label>
                            <textarea class="form-control" id="bookDescription" placeholder="Breve descripción del libro"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer-custom d-flex flex-column flex-md-row justify-content-end gap-2 mt-4">
                        <button type="button" class="btn-secondary-custom" id="btnCancelar">
                            <i data-lucide="x" class="me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn-primary-custom" id="btnGuardar">
                            <i data-lucide="save" class="me-2"></i>Guardar Libro
                        </button>
                    </div>
                </form>
            </div>
<style>
/* Strong override for the specific Agregar Libro button so it doesn't expand
   to full width due to the generic .btn-primary-custom rules. We target by
   ID and class to ensure higher specificity and use !important to override. */
#btnAgregarLibro.btn-primary-custom {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: auto !important;
    max-width: 160px !important;
    min-width: 36px !important;
    padding: 6px 10px !important;
    font-size: 14px !important;
    height: 36px !important;
    border-radius: 8px !important;
    box-sizing: border-box !important;
}
#btnAgregarLibro.btn-primary-custom svg,
#btnAgregarLibro.btn-primary-custom i[data-lucide] { width:18px !important; height:18px !important; }
#btnAgregarLibro.btn-primary-custom .btn-label { display: inline-block; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#btnAgregarLibro.btn-primary-custom:focus { outline: 2px solid rgba(0,0,0,0.06); }

@media (max-width: 768px) {
    .main-content {
        padding: 0.5rem !important;
    }
    .table-responsive-custom {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .table-custom th, .table-custom td {
        white-space: nowrap;
        font-size: 0.95rem;
        padding: 0.5rem 0.3rem;
    }
    .modal-custom {
        max-width: 100vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        border-radius: 0 !important;
        padding: 0.5rem !important;
    }
    .modal-body-custom .row {
        flex-direction: column !important;
    }
}
/* Styles for custom responsive genre picker */
.custom-select-container{position:relative}
.custom-select-input{cursor:pointer;background:#fff}
.custom-select-options{position:absolute;left:0;right:0;z-index:2100;background:#fff;border:1px solid #ddd;border-radius:4px;margin-top:6px;box-shadow:0 6px 18px rgba(0,0,0,0.08);max-height:240px;overflow:auto}
.custom-select-options .option{padding:8px 12px;cursor:pointer}
.custom-select-options .option:hover{background:#f2f6f9}
.custom-select-options .option[aria-selected="true"]{background:#e6f4ea}
                /* Layout tweaks: expand page width for this module and let the table use more room
                    without shrinking text/icons. We increase the container's max-width only for this
                    page (selector targets .container.rol-container) and remove extra inner padding so
                    the table can occupy more horizontal space. */
                .container.rol-container { max-width: 1400px; }
                .table-container { width: 100%; padding: 0; box-sizing: border-box; }
                .table-responsive-custom { overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 0 1rem; }
                .table-custom { width: 100%; table-layout: auto; border-collapse: collapse; }

            /* Basic cell sizing to avoid excessive horizontal growth */
            .table-custom th, .table-custom td { padding: 0.9rem 0.6rem; vertical-align: top; }

            /* Make action column compact and fixed-width so it doesn't push the table wide
               Keep Descripción column behavior unchanged (wraps as before). */
            .table-custom th:last-child, .table-custom td:last-child { width: 72px; text-align: center; white-space: nowrap; }
            .table-custom td:last-child .btn-icon { display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:8px; border:0; background:transparent; padding:0; margin:0 2px; cursor:pointer; }
            .table-custom td:last-child .btn-icon svg { width:18px; height:18px; }
            .table-custom td:last-child .btn-icon:hover { background: rgba(0,0,0,0.04); }

            /* prevent table header icons from adding extra width */
            .table-custom thead th i[data-lucide] { width:18px; height:18px; vertical-align:middle; }

            @media (max-width: 768px) {
                .table-container { padding: 0 0.5rem; }
                .table-custom th, .table-custom td { padding: 0.6rem 0.4rem; font-size: 0.95rem; }
                .table-custom th:last-child, .table-custom td:last-child { width: 64px; }
            }

/* Allow the Descripción column to wrap on small screens and break long words
   Override any earlier 'white-space: nowrap' rules that cause horizontal scroll. */
.table-custom td:nth-child(11), .table-custom th:nth-child(11) {
    white-space: normal !important;
}
.table-custom td:nth-child(11) .desc-preview,
.table-custom td:nth-child(11) .desc-full,
.table-custom td:nth-child(11) > div {
    white-space: normal !important;
    overflow-wrap: anywhere !important;
    word-break: break-word !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    overflow-x: hidden !important; /* hide any small horizontal scroll */
}

/* Ensure modal keeps the dropdown inside viewport on small screens */
.modal-custom{max-width:760px}
@media (max-width:768px){
    .custom-select-options{max-height:180px}
    .modal-custom{width:96vw;max-width:96vw}
}
</style>
<style>
/* Description preview: clamp to 3 lines and offer a reveal button */
.desc-preview { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 3; max-height: calc(1.3em * 3); }
.desc-full { white-space: normal; }
.show-more-btn { display:inline-block; margin-left:8px; background:transparent;border:0;color:var(--clr-gunmetal,#333);cursor:pointer;font-size:0.9rem;padding:0 }
.show-more-btn:focus { outline:2px solid rgba(0,0,0,0.08); border-radius:4px }
</style>

<style>
/* Mobile-specific adjustments: clamp to 2 lines and make add-book button compact */
@media (max-width: 768px) {
    .desc-preview { -webkit-line-clamp: 2; line-clamp: 2; max-height: calc(1.2em * 2); }
    .show-more-btn { font-size: 0.85rem; margin-left:6px }
}

@media (max-width: 480px) {
    /* Make the Agregar Libro button compact: icon-only on very small screens */
    /* Use high-specificity and !important to override global .btn-primary-custom rules that set width:100% */
    #btnAgregarLibro {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 6px 8px !important;
        min-width: 0 !important;
        width: auto !important;
        height: 38px !important;
        border-radius: 8px !important;
        gap: 6px !important;
        box-sizing: border-box !important;
    }
        /* Make Agregar Libro generally smaller on all viewports (not only very small screens) */
        #btnAgregarLibro {
            padding: 6px 10px !important;
            font-size: 14px !important;
            height: 36px !important;
            min-width: 36px !important;
            max-width: 180px !important;
            width: auto !important;
        }
        /* Truncate the label if it's too long so the button doesn't expand */
        #btnAgregarLibro .btn-label {
            display: inline-block;
            max-width: 110px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }
    #btnAgregarLibro i[data-lucide] { width:18px; height:18px; margin-right:0.35rem }
    #btnAgregarLibro .btn-label { display:none !important }
    /* Slightly reduce table cell padding on very small screens */
    .table-custom th, .table-custom td { padding: 0.45rem 0.35rem; font-size:0.92rem }
}
</style>

<script>
// Fallback: if the main module didn't bind the click handler for any reason,
// ensure the Agregar Libro button opens the modal. This is safe to run even
// if libros.js also binds its own handler (both will run).
(function(){
    try {
        const btn = document.getElementById('btnAgregarLibro');
        const bookModal = document.getElementById('bookModal');
        if (!btn || !bookModal) return;
        // If there's already more than one listener, bail (avoids duplicate behavior)
        // We can't reliably count listeners, so add a passive fallback that only
        // toggles the modal if it's currently hidden.
        btn.addEventListener('click', function fallbackOpen(e){
            try {
                if (!bookModal.classList.contains('d-none')) return; // modal already open
                bookModal.classList.remove('d-none');
                // ensure focus lands on the modal title for accessibility
                const mt = document.getElementById('modalTitle'); if (mt) mt.focus && mt.focus();
            } catch (err) { /* ignore */ }
        });
    } catch (e) { /* ignore */ }
})();
</script>

<script>
// Enhance description cells: clamp preview + show more/less. Works for static and dynamically injected rows.
document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('booksTableBody');
    if (!tbody) return;

    function enhanceRowDescriptions() {
        [...tbody.querySelectorAll('tr')].forEach(tr => {
            const cells = tr.querySelectorAll('td');
            // description is the 11th column (index 10)
            if (!cells || cells.length < 11) return;
            const descCell = cells[10];
            if (!descCell || descCell.dataset.enhanced) return;
            const rawText = (descCell.textContent || '').trim();
            if (!rawText) { descCell.dataset.enhanced = '1'; return; }
            // create wrapper and button
            const wrapper = document.createElement('div'); wrapper.className = 'desc-preview'; wrapper.textContent = rawText;
            descCell.textContent = '';
            descCell.appendChild(wrapper);
            if (rawText.length > 180) {
                const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'show-more-btn'; btn.textContent = 'Mostrar más';
                btn.addEventListener('click', function () {
                    if (wrapper.classList.contains('desc-preview')) {
                        wrapper.classList.remove('desc-preview');
                        btn.textContent = 'Mostrar menos';
                    } else {
                        wrapper.classList.add('desc-preview');
                        btn.textContent = 'Mostrar más';
                        // scroll cell into view if needed
                        descCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
                descCell.appendChild(btn);
            }
            descCell.dataset.enhanced = '1';
        });
    }

    // Observe for dynamic changes (e.g., libros.js populating rows)
    const obs = new MutationObserver((mutations) => {
        enhanceRowDescriptions();
    });
    obs.observe(tbody, { childList: true, subtree: true });

    // initial run in case there are static rows
    enhanceRowDescriptions();
});
</script>
        </div>
    </div>

    <script type="module" src="{{ url_for('static', filename='js/apiClient.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/libros.js') }}"></script>
</main>
<!-- Confirmation modal (reusable) -->
<div class="modal-overlay d-none" id="confirmModal">
    <div class="modal-custom" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
        <div class="modal-header-custom d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center"><i data-lucide="trash-2" class="me-2 text-danger"></i><h3 id="confirmModalTitle" class="modal-title mb-0">Confirmar acción</h3></div>
            <button class="btn-close-modal" id="confirmModalClose">✕</button>
        </div>
        <div class="modal-body-custom">
            <p id="confirmModalMessage">¿Confirmar?</p>
        </div>
        <div class="modal-footer-custom d-flex justify-content-end gap-2">
            <button type="button" class="btn-secondary-custom" id="confirmCancelBtn">Cancelar</button>
            <button type="button" class="btn-primary-custom" id="confirmOkBtn">Confirmar</button>
        </div>
    </div>
</div>
<style>
/* Compact, attractive confirm modal */
#confirmModal .modal-custom{max-width:430px;padding:0.6rem;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
#confirmModal .modal-custom{transform:scale(.96);opacity:0;transition:transform .18s ease, opacity .18s ease}
#confirmModal:not(.d-none) .modal-custom{transform:scale(1);opacity:1}
#confirmModal .modal-header-custom{padding:0.6rem 0.8rem;border-bottom:1px solid #eef2f6}
#confirmModal .modal-body-custom{padding:0.8rem 0.9rem;font-size:0.95rem;color:#222}
#confirmModal .modal-footer-custom{padding:0.6rem 0.9rem}
#confirmModal .modal-title{font-size:1rem;margin:0}
#confirmModal .btn-primary-custom{background:var(--clr-celadon);border:0;padding:0.45rem 0.9rem;border-radius:6px;color:var(--clr-gunmetal)}
#confirmModal .btn-secondary-custom{background:var(--clr-ghost-white);border:0;padding:0.45rem 0.9rem;border-radius:6px;color:var(--clr-gunmetal)}
#confirmModal .btn-close-modal{background:transparent;border:0;font-size:1rem}
@media (max-width:480px){ #confirmModal .modal-custom{width:92vw;max-width:92vw}}
</style>
{% endblock %}
